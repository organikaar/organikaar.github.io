<!doctype html> 
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙØ±Ù… Ø³ÙØ§Ø±Ø´ - Ø§Ø±Ú¯Ø§Ù†ÛŒÚ©Ø§Ø±</title>

  <!-- Fonts: Ø§Ú¯Ø± ÙØ§ÛŒÙ„ ÙÙˆÙ†Øª Ù…Ø­Ù„ÛŒ Ø¯Ø§Ø±ÛŒØŒ @font-face Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† -->
  <style>
    /* Ù…Ø«Ø§Ù„ Ø³Ø§Ø¯Ù‡ ÙÙˆÙ†Øª. Ø§Ú¯Ø± IranYekan/ Shabnam Ø¯Ø§Ø±ÛŒØŒ @font-face Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø°Ø§Ø± */
    body { font-family: "IRAN-Sans", "Tahoma", sans-serif; background:#f6fbf6; margin:0; color:#104431; }
    :root{
      --green:#0f6b52;
      --accent:#0c6a4e;
      --cream:#ffffff;
      --muted:#9aaea3;
      --card-shadow: 0 6px 18px rgba(15,107,82,0.08);
      --radius:14px;
    }

    /* ØµÙØ­Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø± */
    .wrap{max-width:1100px;margin:28px auto;padding:18px;}
    header{display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px;border-radius:12px 12px 8px 8px;background:linear-gradient(180deg,var(--green),#0e6a48);color:white}
    header img{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.12)}
    header h1{margin:0;font-size:20px;letter-spacing:0.6px}
    header p{margin:0;font-size:14px;opacity:0.95}

    /* Ù…Ø­ØµÙˆÙ„Ø§Øª */
    .products{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:26px}
    .card{background:var(--cream);border-radius:12px;padding:14px;box-shadow:var(--card-shadow);display:flex;flex-direction:column;align-items:center;transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 30px rgba(15,107,82,0.12)}
    .card img{width:120px;height:120px;object-fit:cover;border-radius:10px;border:1px solid #eee}
    .card .title{margin-top:10px;font-weight:700}
    .card .desc{font-size:13px;color:var(--muted);margin-top:6px;text-align:center;min-height:36px}
    .price{margin-top:8px;font-weight:800;color:var(--green)}
    .qty{display:flex;align-items:center;gap:8px;margin-top:10px}
    .btn-circle{width:34px;height:34px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;border:none;background:var(--green);color:white;font-weight:700;cursor:pointer}
    .qty .num{min-width:34px;text-align:center;font-weight:700}

    /* ÙØ§Ú©ØªÙˆØ± */
    .invoice-card{margin-top:28px;background:var(--cream);border-radius:14px;padding:18px;border:2px solid rgba(15,107,82,0.08);box-shadow:var(--card-shadow)}
    .invoice-card h3{text-align:center;margin:8px 0 18px}
    table{width:100%;border-collapse:collapse}
    table th, table td{padding:8px;border:1px solid #e6f0ea;text-align:center}
    table th{background:var(--green);color:white}
    .summary{display:flex;justify-content:space-between;margin-top:12px;font-weight:800}

    /* ÙØ±Ù… ÙˆØ±ÙˆØ¯ÛŒ */
    form{margin-top:26px;background:#fff;border-radius:12px;padding:18px;box-shadow:var(--card-shadow)}
    .form-row{display:flex;gap:12px;flex-wrap:wrap}
    .field{flex:1;min-width:220px;display:flex;flex-direction:column;margin-bottom:12px}
    .field label{font-size:13px;margin-bottom:6px;color:#28583f}
    .field input, .field textarea{padding:10px;border-radius:8px;border:1px solid #dfeee6;background:#fbfffb}
    textarea{min-height:90px;resize:vertical}
    .error{color:#b83b3b;font-size:13px;margin-top:6px;display:none}

    /* CTA */
    .cta-row{display:flex;gap:12px;justify-content:center;margin-top:18px}
    .btn{background:var(--green);color:white;padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:800;box-shadow:0 6px 14px rgba(15,107,82,0.12)}
    .btn.secondary{background:transparent;border:2px solid var(--green);color:var(--green);font-weight:700}

    /* Modal preview ÙØ§Ú©ØªÙˆØ± Ù†Ù‡Ø§ÛŒÛŒ */
    .overlay{position:fixed;inset:0;background:rgba(6,12,8,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:1200}
    .modal{background:white;border-radius:12px;padding:18px;max-width:900px;width:100%;max-height:90vh;overflow:auto}
    .modal .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .small-muted{font-size:13px;color:#7b8f86}

    /* Responsive */
    @media (max-width:900px){ .products{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){
      .products{grid-template-columns:1fr;gap:12px}
      .form-row{flex-direction:column}
      header img{width:68px;height:68px}
    }

    /* Ø¸Ø§Ù‡Ø±Ø³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ø§ÙÚ©Øª */
    .tiny{font-size:12px;padding:8px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="image/logo.png" alt="logo">
      <h1>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø§Ø±Ú¯Ø§Ù†ÛŒÚ© Ø§Ø±Ú¯Ø§Ù†ÛŒÚ©Ø§Ø±</h1>
      <p>Ø·Ø¨ÛŒØ¹ØªØŒ Ø¯Ø± Ø®Ø§Ù„Øµâ€ŒØªØ±ÛŒÙ† Ø´Ú©Ù„Ø´ Ø¯Ø± Ø§Ø±Ú¯Ø§Ù†ÛŒÚ©Ø§Ø± ğŸŒ¿</p>
    </header>

    <!-- Ù…Ø­ØµÙˆÙ„Ø§Øª -->
    <section id="products" class="products" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„Ø§Øª">
      <!-- Ú©Ø§Ø±Øª Ù…Ø­ØµÙˆÙ„Ø§Øª ØªÙˆØ³Ø· JS Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
    </section>

    <!-- ÙØ§Ú©ØªÙˆØ± (Ø¢Ù†ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯) -->
    <section class="invoice-card" aria-label="ÙØ§Ú©ØªÙˆØ± Ø®Ø±ÛŒØ¯">
      <h3>ÙØ§Ú©ØªÙˆØ± Ø®Ø±ÛŒØ¯</h3>
      <div id="invoice-area">
        <table id="invoice-table" aria-live="polite">
          <thead>
            <tr><th>Ù…Ø­ØµÙˆÙ„</th><th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</th><th>Ù…Ø¬Ù…ÙˆØ¹ (ØªÙˆÙ…Ø§Ù†)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="summary">
          <div>Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: <span id="trackingDisplay">â€”</span></div>
          <div>Ø¬Ù…Ø¹ Ú©Ù„: <span id="totalDisplay">0</span> ØªÙˆÙ…Ø§Ù†</div>
        </div>
      </div>
    </section>

    <!-- ÙØ±Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ -->
    <form id="customerForm" novalidate>
      <div class="form-row">
        <div class="field">
          <label for="fullname">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
          <input id="fullname" name="fullname" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…ÛŒØ«Ù… Ø±Ø¶Ø§ÛŒÛŒ" required>
          <div class="error" id="err-fullname">Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (ÙØ§Ø±Ø³ÛŒØŒ Ø­Ø¯Ø§Ù‚Ù„ Ø¯Ùˆ Ø­Ø±Ù)</div>
        </div>
        <div class="field">
          <label for="mobile">Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡</label>
          <input id="mobile" name="mobile" type="tel" placeholder="09xxxxxxxxx" required>
          <div class="error" id="err-mobile">Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 0912xxxxxxx)</div>
        </div>

        <div class="field" style="flex-basis:100%">
          <label for="address">Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„</label>
          <textarea id="address" name="address" placeholder="Ø¢Ø¯Ø±Ø³ Ù¾Ø³ØªÛŒØŒ Ø§Ø³ØªØ§Ù†ØŒ Ø´Ù‡Ø±ØŒ Ø®ÛŒØ§Ø¨Ø§Ù†ØŒ Ù¾Ù„Ø§Ú©..." required></textarea>
          <div class="error" id="err-address">Ø¢Ø¯Ø±Ø³ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø­Ø¯Ø§Ù‚Ù„ Û±Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)</div>
        </div>

        <div class="field">
          <label for="postal">Ú©Ø¯ Ù¾Ø³ØªÛŒ</label>
          <input id="postal" name="postal" type="text" placeholder="Û±Û° Ø±Ù‚Ù…" required>
          <div class="error" id="err-postal">Ú©Ø¯Ù¾Ø³ØªÛŒ Ù…Ø¹ØªØ¨Ø± (Û±Û° Ø±Ù‚Ù…) ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
        </div>

        <div class="field">
          <label for="note">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø³ÙØ§Ø±Ø´ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <textarea id="note" name="note" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø²Ù…Ø§Ù† ØªØ­ÙˆÛŒÙ„ Ù…ÙˆØ±Ø¯Ù†Ø¸Ø±"></textarea>
        </div>
      </div>

      <div class="cta-row">
        <button type="button" id="confirmBtn" class="btn">ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ</button>
        <a href="https://instagram.com/organikaar" target="_blank" rel="noopener" class="btn secondary">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ (@organikaar)</a>
      </div>
    </form>
  </div>

  <!-- Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± Ù…ÙˆØ¯Ø§Ù„ -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="finalTitle">
      <div class="top">
        <h2 id="finalTitle">Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± / ÙØ§Ú©ØªÙˆØ± Ù†Ù‡Ø§ÛŒÛŒ</h2>
        <div><button id="closePreview" class="btn secondary tiny">Ø¨Ø³ØªÙ†</button></div>
      </div>

      <div id="finalContent" style="margin-top:12px">
        <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ -->
        <div style="border-bottom:1px solid #eef6ef;padding-bottom:12px;margin-bottom:12px">
          <div><strong id="fvName"></strong></div>
          <div class="small-muted" id="fvContact"></div>
          <div class="small-muted" id="fvAddress" style="margin-top:6px"></div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ ÙØ§Ú©ØªÙˆØ± -->
        <div id="finalInvoiceTable"></div>

        <div style="margin-top:12px">
          <div><strong>Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ:</strong> <span id="fvTracking"></span></div>
          <div style="margin-top:6px"><strong>Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¬Ù‡Øª ÙˆØ§Ø±ÛŒØ²:</strong> <span id="cardNumber">6789-2345-9071-4037</span></div>
          <p style="margin-top:10px">Ù„Ø·ÙØ§ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ² Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ±ØŒ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ Ø¯Ø§ÛŒØ±Ú©Øª Ø§Ø±Ø³Ø§Ù„ Ù†Ù…Ø§ÛŒÛŒØ¯. Ø¨Ø§ ØªØ´Ú©Ø±.</p>
        </div>

        <div style="display:flex;gap:8px;justify-content:center;margin-top:16px">
          <button id="saveInvoice" class="btn">Ø°Ø®ÛŒØ±Ù‡ ÙØ§Ú©ØªÙˆØ±</button>
          <button id="editInvoice" class="btn secondary">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù‚Ø¨Ù„</button>
          <button id="exitInvoice" class="btn secondary">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ html2pdf Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾ÛŒâ€ŒØ¯ÛŒâ€ŒØ§Ù (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
  /*************************************************
   * ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª
   *************************************************/
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycby8QkFQqDqUCikASXGDoVrZqT7Z-KVtFbUs6UiU-3R9U7EBBtmryO3saFgHuVyNhZ6WDQ/exec";
  const BACKEND_SECRET = "Meysam0640346960";

  // Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª: Ø¨Ø±Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø­ØµÙˆÙ„ØŒ ÛŒÚ© Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§ÛŒÙ† Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
  const PRODUCTS = [
    { id: "zaferan", title: "Ø²Ø¹ÙØ±Ø§Ù†", price: 250000, image: "image/zaferan.jpg", unit: "ÛŒÚ© Ø¨Ø³ØªÙ‡" },
    { id: "zereshk", title: "Ø²Ø±Ø´Ú©", price: 120000, image: "image/zereshk.jpg", unit: "ÛŒÚ© Ø¨Ø³ØªÙ‡" },
    { id: "anab", title: "Ø¹Ù†Ø§Ø¨", price: 100000, image: "image/anab.jpg", unit: "ÛŒÚ© Ø¨Ø³ØªÙ‡" },
    { id: "asal", title: "Ø¹Ø³Ù„", price: 180000, image: "image/asal.jpg", unit: "ÛŒÚ© Ø´ÛŒØ´Ù‡" }
  ];

  // ÙˆØ¶Ø¹ÛŒØª Ø³Ø¨Ø¯
  let cart = {}; // { productId: qty }
  // ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³/ØªØ±Ø§Ú©Ù†Ø´
  let trackingId = null;
  const STORAGE_KEY = 'organikaar_order_draft';

  /*************************************************
   * Util: generate tracking id
   *************************************************/
  function genTracking() {
    const dt = new Date();
    const pad = n => String(n).padStart(2,'0');
    const stamp = `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}-${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}`;
    const rand = Math.floor(Math.random()*900+100);
    return `ORG-${stamp}-${rand}`;
  }

  /*************************************************
   * Render products
   *************************************************/
  const productsEl = document.getElementById('products');
  function renderProducts(){
    productsEl.innerHTML = '';
    PRODUCTS.forEach(p=>{
      const qty = cart[p.id] || 0;
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <img src="${p.image}" alt="${p.title}">
        <div class="title">${p.title}</div>
        <div class="desc">${p.unit}</div>
        <div class="price">${p.price.toLocaleString()}</div>
        <div class="qty">
          <button class="btn-circle" data-action="dec" data-id="${p.id}">âˆ’</button>
          <div class="num" id="num-${p.id}">${qty}</div>
          <button class="btn-circle" data-action="inc" data-id="${p.id}">+</button>
        </div>
      `;
      productsEl.appendChild(div);
    });
  }

  // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø§ÙØ²Ø§ÛŒØ´/Ú©Ø§Ù‡Ø´
  productsEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    if(action === 'inc'){ cart[id] = (cart[id]||0) + 1; }
    if(action === 'dec'){ cart[id] = Math.max(0,(cart[id]||0)-1); if(cart[id]===0) delete cart[id]; }
    saveDraftToLocal();
    updateUI();
  });

  /*************************************************
   * Invoice rendering
   *************************************************/
  const invoiceTbody = document.querySelector('#invoice-table tbody');
  const totalDisplay = document.getElementById('totalDisplay');
  const trackingDisplay = document.getElementById('trackingDisplay');

  function updateUI(){
    // Ø¬Ø¯ÙˆÙ„
    invoiceTbody.innerHTML = '';
    let total = 0;
    Object.keys(cart).forEach(pid=>{
      const p = PRODUCTS.find(x=>x.id===pid);
      const qty = cart[pid];
      const line = p.price * qty;
      total += line;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.title}</td><td>${qty}</td><td>${p.price.toLocaleString()}</td><td>${line.toLocaleString()}</td>`;
      invoiceTbody.appendChild(tr);
    });
    totalDisplay.textContent = total.toLocaleString();
    trackingDisplay.textContent = trackingId || 'â€”';
    // Ù†ÙˆØ´ØªÙ† Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ qty Ø±ÙˆÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
    PRODUCTS.forEach(p=>{
      const el = document.getElementById(`num-${p.id}`);
      if(el) el.textContent = cart[p.id]||0;
    });
  }

  /*************************************************
   * Local draft save/load (Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø²Ú¯Ø´Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
   *************************************************/
  function saveDraftToLocal(){
    const formVals = getFormValues();
    const payload = { cart, form: formVals, trackingId };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }
  function loadDraftFromLocal(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const obj = JSON.parse(raw);
      cart = obj.cart || {};
      trackingId = obj.trackingId || null;
      // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
      if(obj.form){
        document.getElementById('fullname').value = obj.form.fullname || '';
        document.getElementById('mobile').value = obj.form.mobile || '';
        document.getElementById('address').value = obj.form.address || '';
        document.getElementById('postal').value = obj.form.postal || '';
        document.getElementById('note').value = obj.form.note || '';
      }
    }catch(e){}
  }

  /*************************************************
   * Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ (Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§ÛŒØ±Ø§Ù†)
   *************************************************/
  function validateForm(){
    let ok=true;
    const fullname = document.getElementById('fullname').value.trim();
    const mobile = document.getElementById('mobile').value.trim();
    const address = document.getElementById('address').value.trim();
    const postal = document.getElementById('postal').value.trim();

    // Ù†Ø§Ù…: Ø­Ø¯Ø§Ù‚Ù„ 2 Ø­Ø±Ù (ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø­Ø±ÙˆÙ Ù„Ø§ØªÛŒÙ†)
    if(!/^.{2,}$/.test(fullname)){ document.getElementById('err-fullname').style.display='block'; ok=false; } else document.getElementById('err-fullname').style.display='none';

    // Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§ÛŒØ±Ø§Ù†: 09xxxxxxxxx (11 Ø±Ù‚Ù…)
    if(!/^09\d{9}$/.test(mobile)){ document.getElementById('err-mobile').style.display='block'; ok=false; } else document.getElementById('err-mobile').style.display='none';

    // Ø¢Ø¯Ø±Ø³: Ø­Ø¯Ø§Ù‚Ù„ 10 Ú©Ø§Ø±Ø§Ú©ØªØ±
    if(address.length < 10){ document.getElementById('err-address').style.display='block'; ok=false; } else document.getElementById('err-address').style.display='none';

    // Ú©Ø¯Ù¾Ø³ØªÛŒ Ø§ÛŒØ±Ø§Ù†: 10 Ø±Ù‚Ù…
    if(!/^\d{10}$/.test(postal)){ document.getElementById('err-postal').style.display='block'; ok=false; } else document.getElementById('err-postal').style.display='none';

    // Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
    if(Object.keys(cart).length === 0){
      alert("Ù„Ø·ÙØ§ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
      ok=false;
    }
    return ok;
  }

  function getFormValues(){
    return {
      fullname: document.getElementById('fullname').value.trim(),
      mobile: document.getElementById('mobile').value.trim(),
      address: document.getElementById('address').value.trim(),
      postal: document.getElementById('postal').value.trim(),
      note: document.getElementById('note').value.trim(),
    };
  }

  /*************************************************
   * Ø±ÙØªØ§Ø± Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ
   *************************************************/
  const confirmBtn = document.getElementById('confirmBtn');
  const overlay = document.getElementById('overlay');

  confirmBtn.addEventListener('click', async ()=>{
    if(!validateForm()) return;

    // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² trackingId Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡ØŒ Ø¨Ø³Ø§Ø²Ø´ Ùˆ Ø¯Ø± local Ø°Ø®ÛŒØ±Ù‡ Ú©Ù† (Ø§ÛŒÙ† ØªØ¶Ù…ÛŒÙ† Ù…ÛŒÚ©Ù†Ù‡ Ú©Ù‡ Ø¨Ø¹Ø¯Ø§ Ø¹ÙˆØ¶ Ù†Ø´Ù‡)
    if(!trackingId){
      trackingId = genTracking();
      saveDraftToLocal();
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
    fillFinalModal();
    overlay.style.display = 'flex';

    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ backend (append ÛŒØ§ update)
    await sendInvoiceToBackend(false); // false ÛŒØ¹Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡ (still pending) â€” backend Ø®ÙˆØ¯Ø´ Ø¢Ù¾Ø¯ÛŒØª/append Ù…ÛŒâ€ŒÚ©Ù†Ø¯
  });

  // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ù…ÙˆØ¯Ø§Ù„
  function fillFinalModal(){
    const f = getFormValues();
    document.getElementById('fvName').textContent = f.fullname;
    document.getElementById('fvContact').textContent = `Ù‡Ù…Ø±Ø§Ù‡: ${f.mobile} â€” Ú©Ø¯Ù¾Ø³ØªÛŒ: ${f.postal}`;
    document.getElementById('fvAddress').textContent = f.address;
    document.getElementById('fvTracking').textContent = trackingId;
    // Ø¬Ø¯ÙˆÙ„
    let html = '<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#0f6b52;color:white"><th>Ù…Ø­ØµÙˆÙ„</th><th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th><th>Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead><tbody>';
    let total=0;
    Object.keys(cart).forEach(pid=>{
      const p = PRODUCTS.find(x=>x.id===pid);
      const qty = cart[pid];
      const line = p.price * qty;
      total += line;
      html += `<tr><td style="padding:8px">${p.title}</td><td style="text-align:center">${qty}</td><td style="text-align:center">${p.price.toLocaleString()}</td><td style="text-align:center">${line.toLocaleString()}</td></tr>`;
    });
    html += `</tbody></table><div style="text-align:right;margin-top:8px;font-weight:800">Ø¬Ù…Ø¹ Ú©Ù„: ${total.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>`;
    document.getElementById('finalInvoiceTable').innerHTML = html;
  }

  /*************************************************
   * Ø§Ø±Ø³Ø§Ù„ ÛŒØ§ Ø¢Ù¾Ø¯ÛŒØª ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ backend (Google Sheets)
   * behavior: Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ append ÛŒØ§ insert Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ (Ø¨Ø§ Ù‡Ù…Ø§Ù† trackingId) Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
   *************************************************/
  async function sendInvoiceToBackend(isFinal=true){
    if(!BACKEND_URL || BACKEND_URL.includes("PASTE_YOUR_APPS_SCRIPT_URL_HERE")) {
      console.warn("BACKEND_URL ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡. Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google SheetsØŒ URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡.");
      return;
    }
    const payload = {
      secret: BACKEND_SECRET,
      trackingId,
      timestamp: new Date().toISOString(),
      final: isFinal,
      cart,
      form: getFormValues()
    };
    try{
      const resp = await fetch(BACKEND_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      console.log('backend response', data);
      if(data && data.success) {
        console.log('Saved to backend');
      } else {
        console.warn('backend did not confirm success', data);
      }
    }catch(err){
      console.error('sendInvoiceToBackend error', err);
    }
  }

  /*************************************************
   * Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
   *************************************************/
  document.getElementById('closePreview').addEventListener('click', ()=> overlay.style.display='none');
  document.getElementById('editInvoice').addEventListener('click', ()=>{
    // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù‚Ø¨Ù„ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ â€” Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªØºÛŒÛŒØ± Ø¯Ù‡Ø¯
    overlay.style.display = 'none';
    // ØªÙˆØ¬Ù‡: trackingId Ø¯Ø³Øªâ€ŒÙ†Ø®ÙˆØ±Ø¯Ù‡ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯ (Ù…Ø·Ø§Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡â€ŒØ§Øª)
  });
  document.getElementById('exitInvoice').addEventListener('click', ()=>{
    // Ø®Ø±ÙˆØ¬: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… / ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
    if(confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙØ±Ù… Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯ Ùˆ Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³ Ø­Ø°Ù Ú¯Ø±Ø¯Ø¯ØŸ')) {
      localStorage.removeItem(STORAGE_KEY);
      window.location.href = 'https://instagram.com/organikaar';
    }
  });

  // Ø°Ø®ÛŒØ±Ù‡ ÙØ§Ú©ØªÙˆØ±: Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF + Ø§Ø±Ø³Ø§Ù„ final=true Ø¨Ù‡ backend
  document.getElementById('saveInvoice').addEventListener('click', async ()=>{
    // Ø³Ø§Ø®ØªÙ† Ø¹Ù†ØµØ± Ù‚Ø§Ø¨Ù„ Ù¾Ø±ÛŒÙ†Øª
    const el = document.createElement('div');
    el.style.padding='18px';
    el.style.fontFamily='inherit';
    el.innerHTML = document.getElementById('finalContent').innerHTML;
    document.body.appendChild(el);

    // ØªÙˆÙ„ÙŠØ¯ PDF
    const opt = { margin:0.5, filename:`invoice-${trackingId}.pdf`, html2canvas:{scale:1.4}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'} };
    await html2pdf().set(opt).from(el).save();
    document.body.removeChild(el);

    // Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ backend (Ø¹Ù„Ø§Ù…Øª final)
    await sendInvoiceToBackend(true);

    alert('ÙØ§Ú©ØªÙˆØ± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ù„Ø·ÙØ§ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ø¹Ú©Ø³ ÙÛŒØ´ Ø±Ø§ Ø¯Ø§ÛŒØ±Ú©Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.');
  });

  /*************************************************
   * Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
   *************************************************/
  function init(){
    loadDraftFromLocal();
    renderProducts();
    updateUI();
  }
  init();

  // Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ±Ù… Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± Ù…Ù‚Ø§Ø¯ÛŒØ±
  ['fullname','mobile','address','postal','note'].forEach(id=>{
    document.getElementById(id).addEventListener('input', saveDraftToLocal);
  });

  </script>
</body>
</html>
