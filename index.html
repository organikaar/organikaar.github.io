<script>
/*************************************************
 * تنظیمات Airtable
 *************************************************/
const AIRTABLE_API_KEY = "pat1iEijQv0UVLxkE.c6e172d13028fe54fc3db80daaf8a4ac26045faefac7d80601a4104459a62e26";
const AIRTABLE_BASE_ID = "appLkNDICXNqxSDhG";
const AIRTABLE_TABLE_NAME = "Orders";

/*************************************************
 * لیست محصولات (همانند قبل)
 *************************************************/
const PRODUCTS = [
  { id: "zaferan", title: "زعفران", price: 250000, image: "image/zaferan.jpg", unit: "یک بسته" },
  { id: "zereshk", title: "زرشک", price: 120000, image: "image/zereshk.jpg", unit: "یک بسته" },
  { id: "anab", title: "عناب", price: 100000, image: "image/anab.jpg", unit: "یک بسته" },
  { id: "asal", title: "عسل", price: 180000, image: "image/asal.jpg", unit: "یک شیشه" }
];

let cart = {};
const STORAGE_KEY = 'organikaar_order_draft';

/*************************************************
 * رندر محصولات و مدیریت qty
 *************************************************/
const productsEl = document.getElementById('products');
function renderProducts(){
  productsEl.innerHTML = '';
  PRODUCTS.forEach(p=>{
    const qty = cart[p.id] || 0;
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <img src="${p.image}" alt="${p.title}">
      <div class="title">${p.title}</div>
      <div class="desc">${p.unit}</div>
      <div class="price">${p.price.toLocaleString()}</div>
      <div class="qty">
        <button class="btn-circle" data-action="dec" data-id="${p.id}">−</button>
        <div class="num" id="num-${p.id}">${qty}</div>
        <button class="btn-circle" data-action="inc" data-id="${p.id}">+</button>
      </div>
    `;
    productsEl.appendChild(div);
  });
}

productsEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const action = btn.dataset.action;
  const id = btn.dataset.id;
  if(action === 'inc'){ cart[id] = (cart[id]||0) + 1; }
  if(action === 'dec'){ cart[id] = Math.max(0,(cart[id]||0)-1); if(cart[id]===0) delete cart[id]; }
  saveDraftToLocal();
  updateUI();
});

/*************************************************
 * Invoice rendering
 *************************************************/
const invoiceTbody = document.querySelector('#invoice-table tbody');
const totalDisplay = document.getElementById('totalDisplay');

function updateUI(){
  invoiceTbody.innerHTML = '';
  let total = 0;
  Object.keys(cart).forEach(pid=>{
    const p = PRODUCTS.find(x=>x.id===pid);
    const qty = cart[pid];
    const line = p.price * qty;
    total += line;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.title}</td><td>${qty}</td><td>${p.price.toLocaleString()}</td><td>${line.toLocaleString()}</td>`;
    invoiceTbody.appendChild(tr);
  });
  totalDisplay.textContent = total.toLocaleString();
  PRODUCTS.forEach(p=>{
    const el = document.getElementById(`num-${p.id}`);
    if(el) el.textContent = cart[p.id]||0;
  });
}

/*************************************************
 * Local draft save/load
 *************************************************/
function saveDraftToLocal(){
  const formVals = getFormValues();
  const payload = { cart, form: formVals };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
}
function loadDraftFromLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);
    cart = obj.cart || {};
    if(obj.form){
      document.getElementById('fullname').value = obj.form.fullname || '';
      document.getElementById('mobile').value = obj.form.mobile || '';
      document.getElementById('address').value = obj.form.address || '';
      document.getElementById('postal').value = obj.form.postal || '';
      document.getElementById('note').value = obj.form.note || '';
    }
  }catch(e){}
}

/*************************************************
 * Validate form
 *************************************************/
function validateForm(){
  let ok=true;
  const fullname = document.getElementById('fullname').value.trim();
  const mobile = document.getElementById('mobile').value.trim();
  const address = document.getElementById('address').value.trim();
  const postal = document.getElementById('postal').value.trim();

  if(!/^.{2,}$/.test(fullname)){ document.getElementById('err-fullname').style.display='block'; ok=false; } else document.getElementById('err-fullname').style.display='none';
  if(!/^09\d{9}$/.test(mobile)){ document.getElementById('err-mobile').style.display='block'; ok=false; } else document.getElementById('err-mobile').style.display='none';
  if(address.length < 10){ document.getElementById('err-address').style.display='block'; ok=false; } else document.getElementById('err-address').style.display='none';
  if(!/^\d{10}$/.test(postal)){ document.getElementById('err-postal').style.display='block'; ok=false; } else document.getElementById('err-postal').style.display='none';
  if(Object.keys(cart).length === 0){ alert("لطفا حداقل یک محصول را انتخاب کنید."); ok=false; }
  return ok;
}

function getFormValues(){
  return {
    fullname: document.getElementById('fullname').value.trim(),
    mobile: document.getElementById('mobile').value.trim(),
    address: document.getElementById('address').value.trim(),
    postal: document.getElementById('postal').value.trim(),
    note: document.getElementById('note').value.trim(),
  };
}

/*************************************************
 * ارسال به Airtable
 *************************************************/
async function sendInvoiceToAirtable(){
  const form = getFormValues();
  const itemsText = Object.keys(cart).map(pid=>{
    const p = PRODUCTS.find(x=>x.id===pid);
    return `${p.title} × ${cart[pid]}`;
  }).join('\n');
  const total = Object.keys(cart).reduce((sum,pid)=>{
    const p = PRODUCTS.find(x=>x.id===pid);
    return sum + p.price * cart[pid];
  },0);

  const payload = {
    fields:{
      Date: new Date().toISOString(),
      CustomerName: form.fullname,
      Phone: form.mobile,
      Address: form.address,
      PostalCode: form.postal,
      Items: itemsText,
      Total: total,
      Notes: form.note
    }
  };

  try{
    const res = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`,{
      method:'POST',
      headers:{
        'Authorization':'Bearer '+AIRTABLE_API_KEY,
        'Content-Type':'application/json'
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    console.log('Airtable response', data);
  }catch(err){
    console.error('Airtable error', err);
  }
}

/*************************************************
 * دکمه تایید نهایی
 *************************************************/
document.getElementById('confirmBtn').addEventListener('click', async ()=>{
  if(!validateForm()) return;
  fillFinalModal();
  document.getElementById('overlay').style.display='flex';
  await sendInvoiceToAirtable();
});

/*************************************************
 * مودال پیش‌فاکتور
 *************************************************/
function fillFinalModal(){
  const f = getFormValues();
  document.getElementById('fvName').textContent = f.fullname;
  document.getElementById('fvContact').textContent = `همراه: ${f.mobile} — کدپستی: ${f.postal}`;
  document.getElementById('fvAddress').textContent = f.address;

  let html = '<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#0f6b52;color:white"><th>محصول</th><th>تعداد</th><th>قیمت واحد</th><th>مجموع</th></tr></thead><tbody>';
  let total=0;
  Object.keys(cart).forEach(pid=>{
    const p = PRODUCTS.find(x=>x.id===pid);
    const qty = cart[pid];
    const line = p.price * qty;
    total += line;
    html += `<tr><td style="padding:8px">${p.title}</td><td style="text-align:center">${qty}</td><td style="text-align:center">${p.price.toLocaleString()}</td><td style="text-align:center">${line.toLocaleString()}</td></tr>`;
  });
  html += `</tbody></table><div style="text-align:right;margin-top:8px;font-weight:800">جمع کل: ${total.toLocaleString()} تومان</div>`;
  document.getElementById('finalInvoiceTable').innerHTML = html;
}

/*************************************************
 * بارگذاری اولیه
 *************************************************/
function init(){
  loadDraftFromLocal();
  renderProducts();
  updateUI();
  ['fullname','mobile','address','postal','note'].forEach(id=>document.getElementById(id).addEventListener('input', saveDraftToLocal));
}
init();
</script>
