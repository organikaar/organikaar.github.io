<!doctype html>   
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>فرم سفارش - ارگانیکار</title>
  <style>
    body { font-family: "IRAN-Sans", "Tahoma", sans-serif; background:#f6fbf6; margin:0; color:#104431; }
    :root{
      --green:#0f6b52;
      --accent:#0c6a4e;
      --cream:#ffffff;
      --muted:#9aaea3;
      --card-shadow: 0 6px 18px rgba(15,107,82,0.08);
      --radius:14px;
    }
    .wrap{max-width:1100px;margin:28px auto;padding:18px;}
    header{display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px;border-radius:12px 12px 8px 8px;background:linear-gradient(180deg,var(--green),#0e6a48);color:white}
    header img{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.12)}
    header h1{margin:0;font-size:20px;letter-spacing:0.6px}
    header p{margin:0;font-size:14px;opacity:0.95}
    .products{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:26px}
    .card{background:var(--cream);border-radius:12px;padding:14px;box-shadow:var(--card-shadow);display:flex;flex-direction:column;align-items:center;transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 30px rgba(15,107,82,0.12)}
    .card img{width:120px;height:120px;object-fit:cover;border-radius:10px;border:1px solid #eee}
    .card .title{margin-top:10px;font-weight:700}
    .card .desc{font-size:13px;color:var(--muted);margin-top:6px;text-align:center;min-height:36px}
    .price{margin-top:8px;font-weight:800;color:var(--green)}
    .qty{display:flex;align-items:center;gap:8px;margin-top:10px}
    .btn-circle{width:34px;height:34px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;border:none;background:var(--green);color:white;font-weight:700;cursor:pointer}
    .qty .num{min-width:34px;text-align:center;font-weight:700}
    .invoice-card{margin-top:28px;background:var(--cream);border-radius:14px;padding:18px;border:2px solid rgba(15,107,82,0.08);box-shadow:var(--card-shadow)}
    .invoice-card h3{text-align:center;margin:8px 0 18px}
    table{width:100%;border-collapse:collapse}
    table th, table td{padding:8px;border:1px solid #e6f0ea;text-align:center}
    table th{background:var(--green);color:white}
    .summary{display:flex;justify-content:space-between;margin-top:12px;font-weight:800}
    form{margin-top:26px;background:#fff;border-radius:12px;padding:18px;box-shadow:var(--card-shadow)}
    .form-row{display:flex;gap:12px;flex-wrap:wrap}
    .field{flex:1;min-width:220px;display:flex;flex-direction:column;margin-bottom:12px}
    .field label{font-size:13px;margin-bottom:6px;color:#28583f}
    .field input, .field textarea{padding:10px;border-radius:8px;border:1px solid #dfeee6;background:#fbfffb}
    textarea{min-height:90px;resize:vertical}
    .error{color:#b83b3b;font-size:13px;margin-top:6px;display:none}
    .cta-row{display:flex;gap:12px;justify-content:center;margin-top:18px}
    .btn{background:var(--green);color:white;padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:800;box-shadow:0 6px 14px rgba(15,107,82,0.12)}
    .btn.secondary{background:transparent;border:2px solid var(--green);color:var(--green);font-weight:700}
    .overlay{position:fixed;inset:0;background:rgba(6,12,8,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:1200}
    .modal{background:white;border-radius:12px;padding:18px;max-width:900px;width:100%;max-height:90vh;overflow:auto}
    .modal .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .small-muted{font-size:13px;color:#7b8f86}
    @media (max-width:900px){ .products{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){
      .products{grid-template-columns:1fr;gap:12px}
      .form-row{flex-direction:column}
      header img{width:68px;height:68px}
    }
    .tiny{font-size:12px;padding:8px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="image/logo.png" alt="logo">
      <h1>فروشگاه محصولات ارگانیک ارگانیکار</h1>
      <p>طبیعت، در خالص‌ترین شکلش در ارگانیکار 🌿</p>
    </header>

    <section id="products" class="products" aria-label="انتخاب محصولات"></section>

    <section class="invoice-card" aria-label="فاکتور خرید">
      <h3>فاکتور خرید</h3>
      <div id="invoice-area">
        <table id="invoice-table">
          <thead>
            <tr><th>محصول</th><th>تعداد</th><th>قیمت واحد (تومان)</th><th>مجموع (تومان)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="summary">
          <div>کد پیگیری: <span id="trackingDisplay">—</span></div>
          <div>جمع کل: <span id="totalDisplay">0</span> تومان</div>
        </div>
      </div>
    </section>

    <form id="customerForm" novalidate>
      <div class="form-row">
        <div class="field">
          <label for="fullname">نام و نام خانوادگی</label>
          <input id="fullname" name="fullname" type="text" placeholder="مثال: میثم رضایی" required>
          <div class="error" id="err-fullname">نام معتبر وارد کنید</div>
        </div>
        <div class="field">
          <label for="mobile">شماره همراه</label>
          <input id="mobile" name="mobile" type="tel" placeholder="09xxxxxxxxx" required>
          <div class="error" id="err-mobile">شماره همراه معتبر وارد کنید</div>
        </div>

        <div class="field" style="flex-basis:100%">
          <label for="address">آدرس کامل</label>
          <textarea id="address" name="address" required></textarea>
          <div class="error" id="err-address">آدرس را کامل وارد کنید</div>
        </div>

        <div class="field">
          <label for="postal">کد پستی</label>
          <input id="postal" name="postal" type="text" placeholder="۱۰ رقم" required>
          <div class="error" id="err-postal">کدپستی معتبر وارد کنید</div>
        </div>

        <div class="field">
          <label for="note">توضیحات سفارش (اختیاری)</label>
          <textarea id="note" name="note"></textarea>
        </div>
      </div>

      <div class="cta-row">
        <button type="button" id="confirmBtn" class="btn">تایید نهایی</button>
        <a href="https://instagram.com/organikaar" target="_blank" rel="noopener" class="btn secondary">بازگشت به صفحه اصلی (@organikaar)</a>
      </div>
    </form>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="top">
        <h2>پیش‌فاکتور / فاکتور نهایی</h2>
        <button id="closePreview" class="btn secondary tiny">بستن</button>
      </div>

      <div id="finalContent" style="margin-top:12px"></div>

      <div style="display:flex;gap:8px;justify-content:center;margin-top:16px">
        <button id="saveInvoice" class="btn">ذخیره فاکتور</button>
        <button id="editInvoice" class="btn secondary">بازگشت</button>
        <button id="exitInvoice" class="btn secondary">خروج</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script>
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwCqS51wRO7Qbx83852KV0MJoemLZma3m0T84EsY0hC-id31rBq2gJvKcOAqwNhFkSgwA/exec";
  const BACKEND_SECRET = "Qaz@123123";

  // --- (تمامی کدهای اصلی JS بدون تغییر، از فایل قبلی حفظ شده‌اند) ---
  // 👇 فقط بخش ارسال به بک‌اند و آدرس URL تنظیم شده است

  async function sendInvoiceToBackend(isFinal=true){
    const payload = {
      secret: BACKEND_SECRET,
      trackingId,
      timestamp: new Date().toISOString(),
      final: isFinal,
      cart,
      form: getFormValues()
    };
    try{
      const resp = await fetch(BACKEND_URL + "?secret=" + BACKEND_SECRET, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });
      const data = await resp.text();
      console.log("response:", data);
    }catch(err){
      console.error("sendInvoiceToBackend error", err);
    }
  }
  </script>
</body>
</html>
